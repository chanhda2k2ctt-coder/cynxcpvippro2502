--[[
	MIDNIGHT CHASER FARM - EXTREME PERFORMANCE & SPEED EDITION
	Optimized by Antigravity
]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Cấu hình mặc định (Tốc độ cao)
local Config = {
	Speed = 350, -- Tốc độ cực cao (Cẩn thận rollback)
	TweenTime = 0, -- Tự động tính toán
	AutoFarm = false,
	AutoDeliver = false,
	FPSBoost = true,
	WhiteScreen = false, -- Màn hình trắng để tiết kiệm GPU
}

local State = {
	Car = nil,
	GroundPart = nil,
	BackupFolder = nil,
	CurrentTween = nil
}

-- [HỆ THỐNG TỐI ƯU HÓA FPS CỰC ĐOAN]
local function SuperFPSBoost()
	-- 1. Giảm Setting
	settings().Rendering.QualityLevel = 1
	settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
	
	-- 2. Tắt Lighting
	Lighting.GlobalShadows = false
	Lighting.FogEnd = 9e9
	Lighting.Brightness = 0
	Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
	
	for _, v in pairs(Lighting:GetChildren()) do
		if v:IsA("PostEffect") or v:IsA("Atmosphere") or v:IsA("Sky") then
			v:Destroy()
		end
	end

	-- 3. Xóa Texture & Decals & Effects
	local function clearVisuals()
		for _, v in pairs(Workspace:GetDescendants()) do
			if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Explosion") or v:IsA("Sparkles") then
				v:Destroy()
			elseif v:IsA("MeshPart") then
				-- Giữ lại hình dáng nhưng bỏ texture
				v.RenderFidelity = Enum.RenderFidelity.Precise
				v.Material = Enum.Material.Plastic
				v.Reflectance = 0
			end
		end
	end
	
	clearVisuals()
	Workspace.DescendantAdded:Connect(function(v)
		if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") then
			task.wait()
			v:Destroy()
		end
	end)
	
	-- 4. Ẩn 3D Rendering (Optional: 3D Rendering Disable)
	if Config.WhiteScreen then
		RunService:Set3dRenderingEnabled(false)
	end
end

-- [HỆ THỐNG ANTI-AFK]
if not getgenv().AntiAfkLoaded then
	getgenv().AntiAfkLoaded = true
	local vu = game:GetService("VirtualUser")
	LocalPlayer.Idled:Connect(function()
		vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
		task.wait(1)
		vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
	end)
end

-- [HỆ THỐNG FARM]
local function createGround()
	if not State.GroundPart or not State.GroundPart.Parent then
		local p = Instance.new("Part")
		p.Name = "Speedway"
		p.Size = Vector3.new(100000, 5, 100000)
		p.Anchored = true
		p.Transparency = 1 
		p.CanCollide = true
		p.Position = Vector3.new(0, -400, 0) -- Giấu dưới map
		p.Parent = Workspace
		State.GroundPart = p
	end
end

local function GetCar()
	local char = LocalPlayer.Character
	if not char then return nil end
	local hum = char:FindFirstChild("Humanoid")
	if not hum or not hum.SeatPart then return nil end
	
	local vehicle = hum.SeatPart.Parent
	if vehicle:IsA("Model") then
		return vehicle
	end
	return nil
end

local function BypassVelocity(rootPart)
	-- Giữ vận tốc ổn định để tránh bị server kéo lại
	if rootPart then
		rootPart.AssemblyLinearVelocity = Vector3.zero 
		rootPart.AssemblyAngularVelocity = Vector3.zero
	end
end

local function TweenTo(targetPos, speedOverride)
	local car = GetCar()
	if not car or not car.PrimaryPart then return end

	local root = car.PrimaryPart
	-- Nếu có bộ phận #Weight thì dùng nó làm gốc (game mechanic)
	if car.Body:FindFirstChild("#Weight") then
		root = car.Body["#Weight"]
		car.PrimaryPart = root
	end
	
	createGround()
	
	-- Tính toán vị trí đích
	local targetCFrame
	if typeof(targetPos) == "CFrame" then
		targetCFrame = targetPos
	else
		targetCFrame = CFrame.new(targetPos)
	end
	
	-- Tính toán thời gian & tốc độ
	local speed = speedOverride or Config.Speed
	local dist = (root.Position - targetCFrame.Position).Magnitude
	local time = dist / speed
	
	-- Chia nhỏ Tween để xử lý event (nếu cần) hoặc chạy một mạch
	local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
	
	-- Mô phỏng đường đi
	local cframeValue = Instance.new("CFrameValue")
	cframeValue.Value = root.CFrame
	
	local stepConnection
	stepConnection = cframeValue.Changed:Connect(function(val)
		if not car or not car.Parent or not State.GroundPart then
			stepConnection:Disconnect()
			return
		end
		
		-- Di chuyển Ground theo xe để luôn có đường chạy -> Không bao giờ rớt map
		State.GroundPart.Position = Vector3.new(val.X, val.Y - 10, val.Z) -- Ground sát dưới xe
		
		-- Teleport xe
		car:PivotTo(val)
		
		-- Bypass Physics
		BypassVelocity(root)
	end)
	
	local tween = TweenService:Create(cframeValue, tweenInfo, {Value = targetCFrame})
	State.CurrentTween = tween
	tween:Play()
	tween.Completed:Wait()
	
	if stepConnection then stepConnection:Disconnect() end
	cframeValue:Destroy()
end

-- [QUẢN LÝ OBJECTS - GIẢM LAG]
State.BackupFolder = ReplicatedStorage:FindFirstChild("LagReduction") or Instance.new("Folder", ReplicatedStorage)
State.BackupFolder.Name = "LagReduction"

local function ClearMap()
	-- Dọn sạch map để chạy cho nhanh
	for _, v in pairs(Workspace:GetChildren()) do
		if v:IsA("Model") and v ~= LocalPlayer.Character and v ~= State.Car and v.Name ~= "Speedway" then
			-- Giữ lại các điểm giao hàng nếu cần thiết
			if not v:FindFirstChild("Highlight") and v.Name ~= "GiftPickup" then 
				v.Parent = State.BackupFolder
			end
		end
	end
end

local function RestoreMap()
	for _, v in pairs(State.BackupFolder:GetChildren()) do
		v.Parent = Workspace
	end
end

-- [GIAO DIỆN UI]
local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/chanhda2k2ctt-coder/cynxcpvippro2502/main/ui.lua", true))()
local Window = library:CreateWindow({text = "Midnight Farm SUPER FAST"})

Window:AddToggle("Auto Farm (Quest)", function(state)
	Config.AutoFarm = state
	if state then
		ClearMap()
		createGround()
		task.spawn(function()
			while Config.AutoFarm do
				local car = GetCar()
				if car then
					-- Danh sách điểm farm cố định (đã tối ưu thứ tự)
					local points = {
						Vector3.new(105, -26, 7965),
						Vector3.new(2751, -26, 3694),
						Vector3.new(-6408, -26, -727),
						Vector3.new(-8821, -26, 2042),
						Vector3.new(4887, -26, 1222)
					}
					
					for _, p in ipairs(points) do
						if not Config.AutoFarm then break end
						TweenTo(CFrame.new(p + Vector3.new(0, 10, 0)))
					end
				else
					-- Tự động nhảy lên ghế lái nếu đứng gần (Optional)
				end
				task.wait()
			end
		end)
	else
		if State.CurrentTween then State.CurrentTween:Cancel() end
		RestoreMap()
	end
end)

Window:AddToggle("Auto Deliver (Event)", function(state)
	Config.AutoDeliver = state
	if state then
		ClearMap()
		createGround()
		task.spawn(function()
			while Config.AutoDeliver do
				local car = GetCar()
				if car then
					-- Logic nhận diện quà và điểm giao
					local hasGifts = false 
					-- Check logic quà (giả lập logic cũ nhưng nhanh hơn)
					-- Ở đây ta ưu tiên chạy đến điểm vàng (Highlight)
					
					local target = nil
					local minDist = math.huge
					
					-- Tìm điểm giao hàng
					for _, v in pairs(Workspace:GetChildren()) do
						if v.Name == "" and v:FindFirstChild("Highlight") then
							local d = (car.PrimaryPart.Position - v.WorldPivot.Position).Magnitude
							if d < minDist then
								minDist = d
								target = v
							end
						end
					end
					
					if target then
						-- Chạy đến điểm giao
						TweenTo(target.WorldPivot * CFrame.new(0, 5, 0), Config.Speed)
					else
						-- Không có điểm giao -> Đi lấy quà
						if Workspace:FindFirstChild("GiftPickup") then
							TweenTo(Workspace.GiftPickup.WorldPivot * CFrame.new(0, 5, 0), Config.Speed)
							-- Đợi lấy quà (spam check)
							local sTime = tick()
							repeat 
								task.wait()
								if car.PrimaryPart then
									car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
								end
							until tick() - sTime > 1.5 -- Đứng yên 1.5s để lấy quà
						end
					end
				end
				task.wait()
			end
		end)
	else
		if State.CurrentTween then State.CurrentTween:Cancel() end
		RestoreMap()
	end
end)

-- Tab Settings
Window:AddLabel("--- SETTINGS ---")
Window:AddBox("Speed (Max: 400)", function(obj, focus)
	if focus then
		local s = tonumber(obj.Text)
		if s then Config.Speed = s end
	end
end)

Window:AddButton("Activte FPS BOOST", function()
	SuperFPSBoost()
end)

Window:AddToggle("White Screen (Save GPU)", function(state)
	Config.WhiteScreen = state
	if state then
		RunService:Set3dRenderingEnabled(false)
	else
		RunService:Set3dRenderingEnabled(true)
	end
end)

-- Auto Init
SuperFPSBoost()
warn("Loaded Extreme Speed Script")