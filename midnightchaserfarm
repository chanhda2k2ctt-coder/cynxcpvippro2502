local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- Quản lý trạng thái tập trung (State Management)
local State = {
	AutoFarm = false,
	AutoDeliver = false,
	Speed = 230,
	Car = nil,
	CurrentTween = nil,
	CancelTween = false,
	GroundPart = nil
}

-- Anti-AFK tối ưu
task.spawn(function()
	warn("Anti-AFK initialized")
	VirtualUser:CaptureController()
	LocalPlayer.Idled:Connect(function()
		VirtualUser:Button2Down(Vector2.zero)
		task.wait(0.2)
		VirtualUser:Button2Up(Vector2.zero)
		warn("Anti-AFK activated")
	end)
end)

-- Hàm tối ưu hóa FPS mạnh mẽ (FPS Boost)
local function OptimizeFPS()
	-- Giảm setting Lighting
	Lighting.GlobalShadows = false
	Lighting.FogEnd = 9e9
	Lighting.Brightness = 0
	
	pcall(function()
		settings().Rendering.QualityLevel = "Level01"
	end)

	-- Xóa hiệu ứng Lighting
	for _, v in pairs(Lighting:GetChildren()) do
		if v:IsA("PostEffect") or v:IsA("Atmosphere") or v:IsA("Sky") or v:IsA("DepthOfFieldEffect") or v:IsA("BlurEffect") then
			v:Destroy()
		end
	end

	-- Xóa Texture và Hiệu ứng trong Workspace
	local function clearTextures(obj)
		for _, v in pairs(obj:GetDescendants()) do
			if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
				v:Destroy()
			end
		end
	end
	clearTextures(Workspace)
	
	-- Hook sự kiện khi có object mới để xóa texture luôn (giữ FPS ổn định lâu dài)
	Workspace.DescendantAdded:Connect(function(v)
		if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") then
			task.wait()
			v:Destroy()
		end
	end)
end

-- Đảm bảo part nền để xe chạy
local function ensureGroundPart()
	if not State.GroundPart or not State.GroundPart.Parent then
		local part = Instance.new("Part")
		part.Name = "FarmPlatform"
		part.Anchored = true
		part.Size = Vector3.new(10000, 2, 10000)
		part.Transparency = 0.8 -- Trong suốt cao để đỡ vướng mắt
		part.Color = Color3.fromRGB(0, 0, 0)
		part.Material = Enum.Material.SmoothPlastic
		part.Position = Vector3.new(0, -500, 0) -- Để xa map
		part.Parent = Workspace
		State.GroundPart = part
	end
	return State.GroundPart
end

-- Kiểm tra xe đã đầy quà chưa
local function reachedMax(value)
	if not value then return false end
	local seatCount = 0
	for _, v in pairs(value:GetDescendants()) do
		if v:IsA("Seat") then seatCount = seatCount + 1 end
	end
	
	local targetGifts = seatCount * 5
	local giftsFolder = value:FindFirstChild("Gifts")
	
	if giftsFolder and #giftsFolder:GetChildren() >= targetGifts then
		return true
	end
	return false
end

-- Tối ưu hóa việc ẩn/hiện object (Giảm render parts)
local BackupFolder = ReplicatedStorage:FindFirstChild("mrbackupfolder") or Instance.new("Folder", ReplicatedStorage)
BackupFolder.Name = "mrbackupfolder"

local function hideWorkspaceObjects()
	for _, v in pairs(Workspace:GetChildren()) do
		if v == LocalPlayer.Character or v:IsA("Terrain") or v:IsA("Camera") or v == State.GroundPart then continue end
		-- Không ẩn xe của mình và các điểm quan trọng
		if v.Name:find(LocalPlayer.Name) or v.Name:find("Gift") or v:FindFirstChild("Highlight") then continue end
		
		if v:IsA("Model") or v:IsA("Folder") or v:IsA("MeshPart") or v:IsA("Part") then
			-- Chỉ di chuyển nếu chưa nằm trong backup
			if v.Parent == Workspace then
				v.Parent = BackupFolder
			end
		end
	end
end

local function restoreWorkspaceObjects()
	for _, v in pairs(BackupFolder:GetChildren()) do
		v.Parent = Workspace
		task.wait() -- Restore từ từ để tránh lag spike
	end
end

local function tweenVehicle(car, targetPos, isEventMode)
	if not car or not car.PrimaryPart then return end
	
	local startPos = car.PrimaryPart.Position
	-- Xử lý targetPos có thể là CFrame hoặc Vector3
	local targetVector = (typeof(targetPos) == "CFrame" and targetPos.Position) or targetPos
	local distance = (startPos - targetVector).Magnitude
	
	local speed = isEventMode and (State.CancelTween and 50 or State.Speed) or State.Speed
	if speed <= 0 then speed = 50 end
	
	local time = distance / speed
	local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
	
	local cframeValue = Instance.new("CFrameValue")
	cframeValue.Value = car:GetPrimaryPartCFrame()
	
	-- Connection quản lý cập nhật vị trí
	local con
	con = cframeValue.Changed:Connect(function(val)
		if not car or not car.PrimaryPart or not State.GroundPart then 
			if con then con:Disconnect() end
			if State.CurrentTween then State.CurrentTween:Cancel() end
			return
		end

		local currentPos = val.Position
		
		-- Logic Auto Deliver (Event)
		if isEventMode then
			 if LocalPlayer:DistanceFromCharacter(targetVector) > 100 then
				 State.GroundPart.Position = currentPos - Vector3.new(0, 14, 0)
				 car:PivotTo(CFrame.new(State.GroundPart.Position + Vector3.new(0, 7, 0), targetVector))
				 -- Set velocity để server nhận diện di chuyển (anticheat bypass cơ bản)
				 car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.CFrame.LookVector * speed
			 elseif LocalPlayer:DistanceFromCharacter(targetVector) <= 100 and LocalPlayer:DistanceFromCharacter(targetVector) > 10 then
				 if not State.CancelTween then
					 State.CancelTween = true
					 if State.CurrentTween then State.CurrentTween:Cancel() end
				 end
				 State.GroundPart.Position = currentPos - Vector3.new(0, 8, 0)
				 car:PivotTo(CFrame.new(State.GroundPart.Position + Vector3.new(0, 7, 0), Vector3.new(targetVector.X, car.PrimaryPart.Position.Y, targetVector.Z)))
				 car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.CFrame.LookVector * 20
			 else
				 -- Rất gần
				 car:PivotTo(CFrame.new(Vector3.new(targetVector.X, State.GroundPart.Position.Y + 7, targetVector.Z)))
				 car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
			 end
		else
			-- Logic Farm thường
			State.GroundPart.Position = currentPos - Vector3.new(0, 14, 0)
			car:PivotTo(CFrame.new(State.GroundPart.Position + Vector3.new(0, 7, 0), targetVector))
			car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.CFrame.LookVector * speed
		end
	end)
	
	State.CurrentTween = TweenService:Create(cframeValue, tweenInfo, {Value = CFrame.new(targetVector)})
	State.CurrentTween:Play()
	
	-- Wait for completion or cancellation
	local completed = false
	local connection
	connection = State.CurrentTween.Completed:Connect(function()
		completed = true
	end)
	
	repeat task.wait() until completed or not (State.AutoFarm or State.AutoDeliver)
	
	if con then con:Disconnect() end
	if connection then connection:Disconnect() end
	cframeValue:Destroy()
end

-- UI Setup
local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/Schlabbadabadoo/RandomScripts/refs/heads/main/ui.lua", true))()
local window = library:CreateWindow({
	text = "Midnight Chasers Optimized"
})

window:AddBox("Speed (Default: 230)", function(obj, focus)
	if focus then
		State.Speed = tonumber(obj.Text) or 230
	end
end)

window:AddButton("FPS Boost (Click Once)", function()
	OptimizeFPS()
	warn("FPS Optimized: Shadows off, Textures removed, Effects disabled.")
end)

-- Danh sách điểm farm
local FarmFrames = {
	CFrame.new(105.419128, -26.0098934, 7965.37988),
	CFrame.new(2751.86499, -26.0098934, 3694.63354),
	CFrame.new(-8821.48438, -26.0098934, 2042.49939),
	CFrame.new(-6408.62109, -26.0098934, -727.765198),
	CFrame.new(-6099.79639, -26.0098934, -1027.94556),
	CFrame.new(-6066.70068, -26.0098934, 493.255524),
	CFrame.new(132.786133, -26.0098934, 15.2286377),
	CFrame.new(-7692.85449, -26.0098934, -4668.61963),
	CFrame.new(4887.24609, -26.0098934, 1222.96826)
}

-- Toggle Auto Farm
window:AddToggle("Auto Farm", function(state)
	State.AutoFarm = state
	
	if State.AutoFarm then
		hideWorkspaceObjects()
		
		task.spawn(function()
			while State.AutoFarm do
				local char = LocalPlayer.Character
				if not char then task.wait(1) continue end
				
				local hum = char:FindFirstChild("Humanoid")
				local seat = hum and hum.SeatPart
				
				if seat then
					local car = seat.Parent
					State.Car = car
					ensureGroundPart()
					
					if car.Body:FindFirstChild("#Weight") then
						car.PrimaryPart = car.Body["#Weight"]
					end
					
					for _, targetCFrame in ipairs(FarmFrames) do
						if not State.AutoFarm then break end
						local targetPos = targetCFrame.Position + Vector3.new(0, 5, 0)
						tweenVehicle(car, targetPos, false)
					end
				else
					task.wait(1)
				end
			end
		end)
	else
		if State.CurrentTween then State.CurrentTween:Cancel() end
		restoreWorkspaceObjects()
	end
end)

-- Toggle Auto Deliver (Event)
window:AddToggle("Auto Deliver [Event]", function(state)
	State.AutoDeliver = state
	
	if State.AutoDeliver then
		hideWorkspaceObjects()
		task.spawn(function()
			while State.AutoDeliver do
				task.wait()
				local char = LocalPlayer.Character
				if not char then continue end
				local hum = char:FindFirstChild("Humanoid")
				local seat = hum and hum.SeatPart
				
				if seat then
					local car = seat.Parent
					State.Car = car
					ensureGroundPart()
					if car.Body:FindFirstChild("#Weight") then
						car.PrimaryPart = car.Body["#Weight"]
					end
					
					-- Tìm quà gần nhất
					local bestLocation = nil
					local minDistance = math.huge
					
					for _, v in pairs(Workspace:GetChildren()) do
						-- Logic tìm điểm trả quà
						if v.Name == "" and v:FindFirstChild("Highlight") then
							local dist = (char.PrimaryPart.Position - v.WorldPivot.Position).Magnitude
							if dist < minDistance then
								minDistance = dist
								bestLocation = v
							end
						end
					end
					
					if bestLocation then
						State.CancelTween = false
						tweenVehicle(car, bestLocation.WorldPivot.Position + Vector3.new(0, 5, 0), true)
					elseif Workspace:FindFirstChild("GiftPickup") then
						 -- Quay về lấy quà
						 local pickup = Workspace.GiftPickup.WorldPivot.Position
						 tweenVehicle(car, pickup + Vector3.new(0, 5, 0), false)
						 
						 -- Đợi đầy quà
						 repeat 
							 task.wait(0.2)
							 car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
							 car:PivotTo(CFrame.new(pickup) + Vector3.new(0, 5, 0))
						 until reachedMax(car) or not State.AutoDeliver
					end
				else
					task.wait(1)
				end
			end
		end)
	else
		if State.CurrentTween then State.CurrentTween:Cancel() end
		restoreWorkspaceObjects()
	end
end)